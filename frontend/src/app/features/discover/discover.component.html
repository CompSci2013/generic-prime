<div class="discover-container">
  <!-- Header -->
  <div class="discover-header">
    <h1>{{ domainConfig.domainLabel }}</h1>
    <div class="header-actions">
      <button pButton
              type="button"
              icon="pi pi-refresh"
              label="Refresh"
              (click)="refresh()"
              [loading]="loading"></button>
    </div>
  </div>

  <!-- Filter Panel -->
  <p-panel header="Filters" [toggleable]="true" [collapsed]="false">
    <div class="filter-grid">
      <!-- Manufacturer Filter -->
      <div class="filter-field">
        <label for="manufacturer">Manufacturer</label>
        <input pInputText
               id="manufacturer"
               [(ngModel)]="currentFilters.manufacturer"
               (ngModelChange)="onFilterChange('manufacturer', $event)"
               placeholder="Enter manufacturer...">
      </div>

      <!-- Model Filter -->
      <div class="filter-field">
        <label for="model">Model</label>
        <input pInputText
               id="model"
               [(ngModel)]="currentFilters.model"
               (ngModelChange)="onFilterChange('model', $event)"
               placeholder="Enter model...">
      </div>

      <!-- Year Range -->
      <div class="filter-field">
        <label for="yearMin">Year Min</label>
        <p-inputNumber
          id="yearMin"
          [(ngModel)]="currentFilters.yearMin"
          (ngModelChange)="onFilterChange('yearMin', $event)"
          [showButtons]="true"
          [min]="1900"
          [max]="2026"
          placeholder="Min year">
        </p-inputNumber>
      </div>

      <div class="filter-field">
        <label for="yearMax">Year Max</label>
        <p-inputNumber
          id="yearMax"
          [(ngModel)]="currentFilters.yearMax"
          (ngModelChange)="onFilterChange('yearMax', $event)"
          [showButtons]="true"
          [min]="1900"
          [max]="2026"
          placeholder="Max year">
        </p-inputNumber>
      </div>

      <!-- Body Class -->
      <div class="filter-field">
        <label for="bodyClass">Body Class</label>
        <input pInputText
               id="bodyClass"
               [(ngModel)]="currentFilters.bodyClass"
               (ngModelChange)="onFilterChange('bodyClass', $event)"
               placeholder="Enter body class...">
      </div>

      <!-- Search -->
      <div class="filter-field filter-field-wide">
        <label for="search">Search</label>
        <input pInputText
               id="search"
               [(ngModel)]="currentFilters.search"
               (ngModelChange)="onFilterChange('search', $event)"
               placeholder="Search across all fields...">
      </div>

      <!-- Clear Filters Button -->
      <div class="filter-field">
        <label>&nbsp;</label>
        <button pButton
                type="button"
                label="Clear Filters"
                icon="pi pi-filter-slash"
                class="p-button-outlined"
                (click)="clearFilters()"></button>
      </div>
    </div>
  </p-panel>

  <!-- Data Table -->
  <div class="table-container">
    <p-table
      [value]="results"
      [columns]="domainConfig.tableConfig.columns"
      [dataKey]="domainConfig.tableConfig.dataKey"
      [loading]="loading"
      [lazy]="true"
      [paginator]="true"
      [rows]="currentFilters.size || 20"
      [totalRecords]="totalResults"
      [rowsPerPageOptions]="domainConfig.tableConfig.rowsPerPageOptions || [10, 20, 50]"
      [styleClass]="domainConfig.tableConfig.styleClass || ''"
      [responsiveLayout]="domainConfig.tableConfig.responsiveLayout || 'scroll'"
      [stateStorage]="domainConfig.tableConfig.stateStorage || 'session'"
      [stateKey]="domainConfig.tableConfig.stateKey"
      [expandedRowKeys]="expandedRows"
      (onPage)="onPageChange($event)"
      (onSort)="onSort($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} vehicles">

      <!-- Caption -->
      <ng-template pTemplate="caption">
        <div class="table-caption">
          <span class="caption-text">
            <i class="pi pi-car"></i>
            Vehicle Results
          </span>
          <span class="caption-count">
            {{ totalResults }} total
          </span>
        </div>
      </ng-template>

      <!-- Header -->
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th style="width: 3rem" *ngIf="domainConfig.tableConfig.expandable"></th>
          <th *ngFor="let col of columns"
              [pSortableColumn]="col.sortable ? col.field : undefined"
              [ngStyle]="{'width': col.width}">
            {{ col.header }}
            <p-sortIcon *ngIf="col.sortable" [field]="col.field"></p-sortIcon>
          </th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-vehicle let-columns="columns" let-expanded="expanded">
        <tr>
          <!-- Expand toggle -->
          <td *ngIf="domainConfig.tableConfig.expandable">
            <button type="button"
                    pButton
                    pRipple
                    [pRowToggler]="vehicle"
                    class="p-button-text p-button-rounded p-button-plain"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
            </button>
          </td>

          <!-- Data columns -->
          <td *ngFor="let col of columns">
            {{ vehicle[col.field] }}
          </td>
        </tr>
      </ng-template>

      <!-- Row Expansion -->
      <ng-template pTemplate="rowexpansion" let-vehicle>
        <tr>
          <td [attr.colspan]="domainConfig.tableConfig.columns.length + 1">
            <div class="row-expansion">
              <h3>Vehicle Details: {{ vehicle.manufacturer }} {{ vehicle.model }} ({{ vehicle.year }})</h3>
              <div class="expansion-grid">
                <div class="expansion-field">
                  <strong>Vehicle ID:</strong> {{ vehicle.vehicle_id }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.drive_type">
                  <strong>Drive Type:</strong> {{ vehicle.drive_type }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.engine">
                  <strong>Engine:</strong> {{ vehicle.engine }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.transmission">
                  <strong>Transmission:</strong> {{ vehicle.transmission }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.fuel_type">
                  <strong>Fuel Type:</strong> {{ vehicle.fuel_type }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.vehicle_class">
                  <strong>Vehicle Class:</strong> {{ vehicle.vehicle_class }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.first_seen">
                  <strong>First Seen:</strong> {{ vehicle.first_seen }}
                </div>
                <div class="expansion-field" *ngIf="vehicle.last_seen">
                  <strong>Last Seen:</strong> {{ vehicle.last_seen }}
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="domainConfig.tableConfig.columns.length + 1">
            <div class="empty-message">
              <i class="pi pi-inbox" style="font-size: 3rem"></i>
              <p>No vehicles found</p>
              <p class="empty-hint">Try adjusting your filters</p>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Loading body -->
      <ng-template pTemplate="loadingbody">
        <tr *ngFor="let i of [1,2,3,4,5]">
          <td [attr.colspan]="domainConfig.tableConfig.columns.length + 1">
            <p-skeleton width="100%" height="2rem"></p-skeleton>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Statistics Panel (if enabled) -->
  <p-panel
    *ngIf="domainConfig.features.statistics && (statistics$ | async) as stats"
    header="Statistics"
    [toggleable]="true"
    [collapsed]="true"
    styleClass="statistics-panel">
    <div class="statistics-grid">
      <div class="stat-card">
        <div class="stat-value">{{ stats.totalVehicles }}</div>
        <div class="stat-label">Total Vehicles</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.totalInstances }}</div>
        <div class="stat-label">Total VIN Instances</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.manufacturerCount }}</div>
        <div class="stat-label">Manufacturers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.modelCount }}</div>
        <div class="stat-label">Models</div>
      </div>
    </div>
  </p-panel>
</div>
