<div class="query-control-panel" [attr.data-testid]="environment.includeTestIds ? 'query-control-panel' : null">
  <!-- Compact Header Bar with Dropdown and Actions -->
  <div class="control-header">
    <p-dropdown
      #filterFieldDropdown
      [options]="filterFieldOptions"
      [(ngModel)]="selectedField"
      placeholder="Add filter by field..."
      [filter]="true"
      filterPlaceholder="Search fields..."
      (onChange)="onFieldSelected($event)"
      (keydown)="onDropdownKeydown($event)"
      [showClear]="false"
      optionLabel="label"
      optionValue="value"
      styleClass="filter-field-dropdown"
      [attr.data-testid]="environment.includeTestIds ? 'filter-field-dropdown' : null">
    </p-dropdown>
    <p-button
      label="Clear All"
      icon="pi pi-times"
      (onClick)="clearAll()"
      styleClass="p-button-secondary p-button-sm"
      [disabled]="!hasActiveFiltersOrHighlights()">
    </p-button>
  </div>

  <!-- Active Filters -->
  @if (activeFilters.length > 0) {
    <div class="active-filters">
      <label class="active-filters-label">Active Filters:</label>
      <div class="filter-chips">
        @for (filter of activeFilters; track filter) {
          <p-chip
            [label]="getChipLabel(filter)"
            [removable]="true"
            (onRemove)="removeFilter(filter)"
            (click)="editFilter(filter)"
            styleClass="filter-chip"
            [pTooltip]="getChipTooltip(filter)"
            tooltipPosition="top">
          </p-chip>
        }
      </div>
    </div>
  }

  <!-- Active Highlights -->
  @if (activeHighlights.length > 0) {
    <div class="active-highlights">
      <div class="highlights-header">
        <label class="active-highlights-label">Active Highlights:</label>
        <a
          href="javascript:void(0)"
          class="clear-highlights-link"
          (click)="clearAllHighlights()">
          Clear All Highlights
        </a>
      </div>
      <div class="highlight-chips">
        @for (highlight of activeHighlights; track highlight) {
          <p-chip
            [label]="getChipLabel(highlight)"
            [removable]="true"
            (onRemove)="removeHighlight(highlight)"
            (click)="editHighlight(highlight)"
            styleClass="highlight-chip"
            [pTooltip]="getChipTooltip(highlight)"
            tooltipPosition="top">
          </p-chip>
        }
      </div>
    </div>
  }

  <!-- Multiselect Filter Dialog -->
  <p-dialog
    #multiselectDialog
    [visible]="showMultiselectDialog"
    [header]="multiselectDialogTitle"
    [modal]="true"
    [style]="{width: '50vw', minWidth: '400px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    (onShow)="onMultiselectDialogShow()"
    (onHide)="onDialogHide()">

    <ng-template pTemplate="header">
      <span>{{ multiselectDialogTitle }}</span>
    </ng-template>

    <p class="dialog-subtitle">{{ multiselectDialogSubtitle }}</p>

    <!-- Search Box -->
    @if (!loadingOptions && !optionsError) {
      <div class="p-input-icon-left search-box">
        <i class="pi pi-search"></i>
        <input
          #searchInput
          type="text"
          pInputText
          [(ngModel)]="searchQuery"
          [placeholder]="currentFilterDef?.searchPlaceholder || 'Search...'"
          (ngModelChange)="onSearchChange($event)"
          class="w-full"
          />
      </div>
    }

    <!-- Loading State -->
    @if (loadingOptions) {
      <div class="loading-state">
        <p-progressSpinner [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
        <p>Loading options...</p>
      </div>
    }

    <!-- Error State -->
    @if (optionsError) {
      <div class="error-state">
        <i class="pi pi-exclamation-triangle"></i>
        <p>{{ optionsError }}</p>
        <p-button
          label="Retry"
          icon="pi pi-refresh"
          (onClick)="retryLoadOptions()"
          styleClass="p-button-sm">
        </p-button>
      </div>
    }

    <!-- Options List -->
    @if (!loadingOptions && !optionsError) {
      <div class="options-list">
        @for (option of filteredOptions; track option; let i = $index) {
          <div class="option-item">
            <p-checkbox
              [(ngModel)]="selectedOptions"
              [value]="option.value"
              [binary]="false"
              [inputId]="'option-' + i">
            </p-checkbox>
            <label [for]="'option-' + i">{{ option.label }}</label>
          </div>
        }
        @if (filteredOptions.length === 0) {
          <div class="no-results">
            <p>No options found</p>
          </div>
        }
      </div>
    }

    <!-- Selection Summary -->
    @if (selectedOptions.length > 0 && !loadingOptions) {
      <div class="selection-summary">
        <span>Selected ({{ selectedOptions.length }}): {{ getSelectionSummary() }}</span>
      </div>
    }

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        (onClick)="cancelDialog()"
        styleClass="p-button-text p-button-secondary">
      </p-button>
      <p-button
        label="Apply"
        (onClick)="applyFilter()"
        styleClass="p-button-primary"
        [disabled]="selectedOptions.length === 0">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Year Range Filter Dialog -->
  <p-dialog
    #yearRangeDialog
    [visible]="showYearRangeDialog"
    header="Select Year Range"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    (onShow)="onYearRangeDialogShow()"
    (onHide)="onDialogHide()">

    <p class="dialog-subtitle">Select a year range to filter results. You can select just a start year, end year, or both.</p>

    <!-- Year Inputs (MVP - simple number inputs) -->
    <div class="year-inputs">
      <div class="p-field">
        <label for="yearMin">Start Year</label>
        <p-inputNumber
          id="yearMin"
          [(ngModel)]="yearMin"
          [min]="availableYearRange.min"
          [max]="availableYearRange.max"
          [useGrouping]="false"
          placeholder="e.g., 1980"
          [showButtons]="true"
          [step]="1">
        </p-inputNumber>
      </div>
      <div class="p-field">
        <label for="yearMax">End Year</label>
        <p-inputNumber
          id="yearMax"
          [(ngModel)]="yearMax"
          [min]="yearMin || availableYearRange.min"
          [max]="availableYearRange.max"
          [useGrouping]="false"
          placeholder="e.g., 2003"
          [showButtons]="true"
          [step]="1">
        </p-inputNumber>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        (onClick)="cancelDialog()"
        styleClass="p-button-text p-button-secondary">
      </p-button>
      <p-button
        label="Apply"
        (onClick)="applyYearRange()"
        styleClass="p-button-primary"
        [disabled]="!yearMin && !yearMax">
      </p-button>
    </ng-template>
  </p-dialog>
</div>
