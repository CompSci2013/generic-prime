<div class="ai-chat-container" [class.collapsed]="!isExpanded()">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <i class="pi pi-comments"></i>
      <span class="header-title">AI Assistant</span>
      @if (connectionStatus() === 'connected') {
        <span class="status-indicator connected" pTooltip="Connected to Mimir"></span>
      } @else if (connectionStatus() === 'checking') {
        <span class="status-indicator checking" pTooltip="Checking connection..."></span>
      } @else {
        <span class="status-indicator disconnected" pTooltip="Disconnected - Click to retry" (click)="retryConnection()"></span>
      }
    </div>
    <div class="header-actions">
      @if (hasMessages()) {
        <button
          pButton
          type="button"
          icon="pi pi-trash"
          pTooltip="Clear chat"
          class="p-button-text p-button-sm"
          (click)="clearChat()">
        </button>
      }
      <button
        pButton
        type="button"
        [icon]="isExpanded() ? 'pi pi-chevron-down' : 'pi pi-chevron-up'"
        pTooltip="Toggle panel"
        class="p-button-text p-button-sm"
        (click)="toggleExpanded()">
      </button>
      <button
        pButton
        type="button"
        icon="pi pi-times"
        pTooltip="Close AI Assistant"
        class="p-button-text p-button-sm"
        (click)="close()">
      </button>
    </div>
  </div>

  <!-- Chat Body (collapsible) -->
  @if (isExpanded()) {
    <div class="chat-body">
      <!-- Messages Area -->
      <div class="messages-area" #messagesContainer>
        @if (!hasMessages() && !isLoading()) {
          <div class="welcome-message">
            <i class="pi pi-sparkles"></i>
            <h3>Welcome to AI Assistant</h3>
            @if (hasApiContext()) {
              <p>Ask me anything or search the vehicle database:</p>
              <ul class="example-queries">
                <li (click)="useExampleQuery('Show me all Chevrolet vehicles from 2020 to 2024')">Show me all Chevrolet vehicles from 2020 to 2024</li>
                <li (click)="useExampleQuery('Find Pickup trucks with more than 100 VIN records')">Find Pickup trucks with more than 100 VIN records</li>
                <li (click)="useExampleQuery('What Ford models are available?')">What Ford models are available?</li>
              </ul>
            } @else {
              <p>Ask me anything:</p>
              <ul class="example-queries">
                <li (click)="useExampleQuery('What can you help me with?')">What can you help me with?</li>
                <li (click)="useExampleQuery('Explain how this application works')">Explain how this application works</li>
                <li (click)="useExampleQuery('Tell me a fun fact')">Tell me a fun fact</li>
              </ul>
            }
          </div>
        }

        @for (message of messages(); track message.timestamp) {
          <div [class]="getMessageClass(message)">
            <div class="message-content">
              @if (message.images?.length) {
                <div class="message-images">
                  @for (image of message.images; track $index) {
                    <img [src]="'data:' + image.mimeType + ';base64,' + image.data" alt="Attached image" class="message-image" />
                  }
                </div>
              }
              <div class="message-text" [innerHTML]="renderContent(message.content)"></div>
              @if (message.timestamp) {
                <div class="message-time">{{ formatTime(message.timestamp) }}</div>
              }
            </div>
          </div>
        }

        @if (isLoading()) {
          <div class="message message-assistant loading">
            <div class="message-content">
              <p-progressSpinner
                strokeWidth="3"
                [style]="{ width: '24px', height: '24px' }">
              </p-progressSpinner>
              <span class="loading-text">Thinking...</span>
            </div>
          </div>
        }

        @if (error()) {
          <div class="error-message">
            <i class="pi pi-exclamation-triangle"></i>
            <span>{{ error() }}</span>
            <button pButton type="button" label="Retry" icon="pi pi-refresh" class="p-button-text p-button-sm" (click)="retryConnection()"></button>
          </div>
        }
      </div>

      <!-- Input Area -->
      <div class="input-area">
        @if (connectionStatus() === 'disconnected') {
          <div class="disconnected-notice">
            <i class="pi pi-wifi"></i>
            <span>Cannot connect to AI service on Mimir</span>
            <button pButton type="button" label="Retry" class="p-button-sm" (click)="retryConnection()"></button>
          </div>
        } @else {
          <!-- Pending Image Preview -->
          @if (pendingImage()) {
            <div class="pending-image-preview">
              <img [src]="getPendingImageUrl()" alt="Pending attachment" />
              <button
                pButton
                type="button"
                icon="pi pi-times"
                class="p-button-rounded p-button-danger p-button-sm remove-image-btn"
                (click)="clearPendingImage()"
                pTooltip="Remove image">
              </button>
            </div>
          }
          <div class="input-row">
            <textarea
              #messageInput
              pTextarea
              [(ngModel)]="userMessage"
              placeholder="Type your message or paste an image..."
              [autoResize]="true"
              [rows]="1"
              [disabled]="isLoading() || connectionStatus() !== 'connected'"
              (keydown)="onKeyDown($event)"
              (paste)="onPaste($event)"
              class="message-input">
            </textarea>
            <button
              pButton
              type="button"
              icon="pi pi-send"
              class="send-button"
              [disabled]="(!userMessage.trim() && !pendingImage()) || isLoading() || connectionStatus() !== 'connected'"
              (click)="sendMessage()">
            </button>
          </div>
        }
      </div>
    </div>
  }
</div>
