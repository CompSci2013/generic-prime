# Cline Rules for generic-prime

## Project Overview

This is an Angular 20 application (Generic Discovery Framework) for browsing automobile data.
The frontend uses PrimeNG components and Playwright for E2E testing.

---

## Critical Constraints

### DO NOT
- Run `ng build` or `ng serve` - the dev server runs in a separate SSH session
- Modify frontend code without understanding the full data flow
- Use `router.navigate()` directly - use `UrlStateService` instead
- Create unit tests - testing is E2E only (Playwright)

### ALWAYS
- Ask the user if the dev server is running before executing tests
- Use the correct routes (see below)
- Use the correct data-testid selectors (see below)

---

## Routes

- **Main Discover Page**: `/automobiles/discover`
- **With Filters**: `/automobiles/discover?manufacturer=Chevrolet`
- **Base URL**: `http://localhost:4205`

**WRONG**: `/discover/automobile` (this route does not exist)
**CORRECT**: `/automobiles/discover`

---

## Data Test IDs

These `data-testid` attributes are available in development mode.

**IMPORTANT**: The main discover page uses `BasicResultsTable`, NOT `ResultsTable`.
Use `basic-results-table` and `basic-results-table-panel` for the main data table.

| Component | Test ID | Notes |
|-----------|---------|-------|
| Query Panel | `query-panel` | Main filter container |
| Query Control | `query-control-panel` | Filter controls |
| Filter Dropdown | `filter-field-dropdown` | Field selector |
| **Basic Results Table Panel** | `basic-results-table-panel` | **USE THIS for main table container** |
| **Basic Results Table** | `basic-results-table` | **USE THIS for main p-table** |
| Results Table Panel | `results-table-panel` | Only in pop-out windows |
| Results Table | `results-table` | Only in pop-out windows |
| Picker Panel | `picker-panel` | Manufacturer/Model picker |
| Picker Table | `picker-table` | Picker p-table |
| Statistics Panel | `statistics-panel` | Stats/charts panel |
| Charts | `chart-{id}` | e.g., `chart-manufacturer-distribution` |

---

## Playwright Testing

### Location
- E2E tests: `frontend/e2e/`
- Temporary tests: `frontend/e2e/tests/tmp/` (clean up after use)
- Screenshots: `frontend/screenshots/`

### Running Tests
```bash
cd frontend
npm run test:e2e                    # Run all tests
npx playwright test path/to/test.ts # Run specific test
npm run test:report                 # View results at port 9323
```

### Test Pattern
```typescript
import { test, expect } from '@playwright/test';

test.describe('My Test Suite', () => {
  test('test name', async ({ page }) => {
    await page.goto('/automobiles/discover');
    await page.waitForLoadState('networkidle');
    // Use basic-results-table for the main page (NOT results-table)
    await expect(page.locator('[data-testid="basic-results-table"]')).toBeVisible({ timeout: 10000 });
  });
});
```

### Screenshot with URL Bar (Headless)
```typescript
const injectUrlBar = async (p: typeof page) => {
  await p.evaluate((url) => {
    const div = document.createElement('div');
    div.style.cssText = 'background: #333; color: white; padding: 5px; font-family: monospace; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 999999;';
    div.innerText = `URL: ${url}`;
    document.body.style.marginTop = '30px';
    document.body.appendChild(div);
  }, p.url());
};

await injectUrlBar(page);
await page.screenshot({ path: 'screenshots/my-screenshot.png', fullPage: true });
```

---

## Pop-out Windows

The app has pop-out functionality. To test:

```typescript
const popoutButton = page.locator('button').filter({ has: page.locator('.pi-external-link') }).first();
if (await popoutButton.isVisible()) {
  const [popup] = await Promise.all([
    context.waitForEvent('page'),
    popoutButton.click()
  ]);
  await popup.waitForLoadState('networkidle');
}
```

---

## Project Structure

```
frontend/
├── src/
│   ├── app/                    # App bootstrap, routing
│   ├── framework/              # Domain-agnostic components
│   │   ├── components/         # BasePicker, ResultsTable, etc.
│   │   └── services/           # UrlState, API, etc.
│   └── domain-config/
│       └── automobile/         # Automobile domain config
├── e2e/                        # Playwright tests
│   ├── components/             # Component-specific tests
│   ├── integration/            # Integration tests
│   ├── regression/             # Bug regression tests
│   └── tests/tmp/              # Temporary test scripts
└── playwright.config.ts        # Playwright configuration
```

---

## Documentation

- `CLAUDE.md` - Main instructions for Claude Code
- `docs/claude/PROJECT-STATUS.md` - Current project state
- `docs/claude/NEXT-STEPS.md` - Immediate action items
- `docs/claude/ORIENTATION.md` - Architecture overview
- `docs/guides/UI_Testing_Verification.md` - UI testing guidelines
- `docs/guides/CLINE-TROUBLESHOOTING-GUIDE.md` - **Read this when tests fail**

---

## Technology Stack

| Component | Version |
|-----------|---------|
| Angular | 20.3.15 |
| PrimeNG | 20.4.0 |
| TypeScript | 5.8.3 |
| Playwright | 1.57.0 |

---

## Slash Commands

### `/bootstrap`
Start a fresh cline chat session with project context.

### `/visual-pipeline`
**AUTONOMOUS MODE** - Run the visual testing pipeline without user interaction.

Read `.cline/commands/visual-pipeline.md` for the full workflow, then execute it.

---

## Autonomous Visual Pipeline

When running `/visual-pipeline`, execute these phases WITHOUT asking for user confirmation:

### Phase 1: Screenshot Collection
```bash
cd /home/odin/projects/generic-prime/frontend && npm run visual-collect
```

### Phase 2: Vision Analysis
For each PNG in `frontend/screenshots/captures/`, call Mimir:
```bash
BASE64=$(base64 -w 0 <screenshot.png>)
curl -s http://mimir:11434/api/generate -d '{
  "model": "qwen3-vl:235b-a22b-instruct-q4_K_M",
  "prompt": "Analyze this UI for bugs. Output JSON: {bugs: [{bug_id, severity, component, description, expected, actual, suggested_fix}]}",
  "images": ["'"$BASE64"'"],
  "stream": false
}'
```

### Phase 3: Code Fixes
For each bug, call the coder model:
```bash
curl -s http://mimir:11434/api/generate -d '{
  "model": "qwen3-coder:30b-a3b-q8_0",
  "prompt": "Fix this Angular bug: [bug details]. Provide file path and exact code.",
  "stream": false
}'
```
Then apply the fix by editing the file.

### Phase 4: Verification
Re-run `npm run visual-collect` and re-analyze. If bug persists after 3 attempts, mark unresolved.

### Phase 5: Report
Write results to `frontend/reports/pipeline-report.md`.

**IMPORTANT**: Do NOT ask for confirmation. Execute all phases autonomously.

---

## Mimir LLM Configuration

- **Host**: http://mimir:11434
- **Vision Model**: qwen3-vl:235b-a22b-instruct-q4_K_M (for screenshot analysis)
- **Coder Model**: qwen3-coder:30b-a3b-q8_0 (for code fixes)
